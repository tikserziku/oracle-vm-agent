# Универсальный Голосовой Агент для Управления VM

## Техническое Задание v1.0

### 1. Цель проекта

Создать автономного AI-агента с голосовым управлением для:
- Программирования и деплоя кода на удалённых серверах
- Мониторинга, диагностики и автоисправления ошибок
- Резервного управления и перезагрузки серверов
- Работы с телефона через голосовые команды

### 2. Инфраструктура

```
┌─────────────────────────────────────────────────────────────────┐
│                    РЕЗЕРВНАЯ АРХИТЕКТУРА                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   📱 Телефон                                                    │
│      │                                                          │
│      ▼                                                          │
│   🤖 Telegram Bot (голос/текст)                                 │
│      │                                                          │
│      ├──────────────┬──────────────┬──────────────┐             │
│      ▼              ▼              ▼              ▼             │
│   ┌──────┐      ┌──────┐      ┌──────┐      ┌──────┐           │
│   │ VM1  │◄────►│ VM2  │      │Fly.io│      │GitHub│           │
│   │ Main │      │ Hub  │      │Backup│      │ Repo │           │
│   └──────┘      └──────┘      └──────┘      └──────┘           │
│   92.5.72.169   158.180.56.74  (резерв)    (код/бэкап)         │
│                                                                 │
│   VM1 может перезагрузить VM2                                   │
│   VM2 может перезагрузить VM1                                   │
│   Fly.io - третий резерв если обе VM недоступны                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3. Компоненты системы

#### 3.1 Voice Agent Bot (Telegram)
- Принимает голосовые сообщения
- Транскрибирует через Whisper/Groq
- Понимает команды на русском/английском
- Отвечает голосом (TTS)
- Работает 24/7

#### 3.2 Command Processor (AI Core)
- Парсит команды пользователя
- Определяет целевую VM
- Генерирует код при необходимости
- Принимает решения автономно

#### 3.3 VM Manager (SSH Agent)
- Выполняет команды на VM1/VM2
- Читает логи
- Управляет сервисами
- Загружает/редактирует файлы

#### 3.4 Cross-Reboot System
- VM1 хранит SSH ключи к VM2
- VM2 хранит SSH ключи к VM1
- Каждая VM может перезагрузить другую
- Мониторинг здоровья обеих VM

#### 3.5 Fly.io Fallback
- Легковесный контейнер на Fly.io
- Активируется если обе VM недоступны
- Может перезагрузить VM через Oracle Cloud API

### 4. Команды агента

#### Диагностика
```
"Проверь статус всех сервисов"
"Покажи логи admin-api"
"Что с памятью на первой машине?"
"Есть ли ошибки?"
```

#### Исправление
```
"Перезапусти grok-voice"
"Исправь ошибку в admin-api"
"Обнови конфиг nginx"
```

#### Программирование
```
"Добавь endpoint /health в api"
"Создай новый сервис для обработки..."
"Напиши скрипт для..."
```

#### Резервное управление
```
"Перезагрузи первую машину"
"Перезагрузи вторую машину"
"Перезагрузи обе машины"
```

### 5. Логика автоисправления

```
1. Обнаружена ошибка в логах
   ├─ Ошибка импорта? → Исправить import, перезапустить
   ├─ Порт занят? → Найти процесс, убить, перезапустить
   ├─ Файл не найден? → Создать/восстановить из GitHub
   ├─ Память закончилась? → Очистить логи, перезапустить
   └─ Неизвестная ошибка? → Отправить уведомление пользователю
```

### 6. GitHub Backup

```
Репозиторий: oracle-vm-backup
Структура:
├── vm1/
│   ├── grok-voice/
│   ├── services/
│   └── configs/
├── vm2/
│   ├── apps/
│   ├── services/
│   └── configs/
└── agent/
    ├── voice-agent.py
    └── vm-manager.js
```

### 7. Безопасность

- SSH ключи хранятся локально на каждой VM
- Telegram Bot доступен только авторизованным пользователям
- Критические команды (reboot, delete) требуют подтверждения
- Все действия логируются

### 8. Файлы проекта

```
MCP-HUB/
├── UNIVERSAL_AGENT_SPEC.md     # Это ТЗ
├── CLAUDE.md                    # Правила для Claude
├── oracle-dual-vm.js            # MCP сервер SSH
├── voice-agent/
│   ├── bot.py                   # Telegram бот
│   ├── processor.py             # Обработчик команд
│   ├── vm_manager.py            # Управление VM
│   ├── cross_reboot.py          # Взаимная перезагрузка
│   └── github_backup.py         # Бэкапы на GitHub
└── deploy/
    ├── vm1-agent.service        # Systemd для VM1
    └── vm2-agent.service        # Systemd для VM2
```

### 9. Этапы реализации

| # | Этап | Описание |
|---|------|----------|
| 1 | GitHub | Создать репо, настроить бэкапы |
| 2 | Cross-Reboot | Настроить взаимную перезагрузку VM |
| 3 | Voice Bot | Telegram бот с голосовым вводом |
| 4 | Commands | Базовые команды (статус, логи, рестарт) |
| 5 | AI Core | Интеграция с Claude/Groq для понимания |
| 6 | Auto-Fix | Автоматическое исправление ошибок |
| 7 | Fly.io | Резервный контроллер |

### 10. API Endpoints (на каждой VM)

```
GET  /agent/health          - Статус агента
GET  /agent/vm/status       - Статус VM
POST /agent/vm/reboot       - Перезагрузить VM
POST /agent/service/restart - Перезапустить сервис
GET  /agent/logs/:service   - Получить логи
POST /agent/code/deploy     - Деплой кода
POST /agent/backup          - Бэкап на GitHub
```

---

## Архитектура детально

### Поток голосовой команды

```
📱 Голос "Перезапусти voice сервис"
    │
    ▼
🎤 Telegram получает voice message
    │
    ▼
🔊 Whisper/Groq транскрибирует → "Перезапусти voice сервис"
    │
    ▼
🧠 AI анализирует команду:
    - Действие: restart
    - Сервис: grok-voice
    - VM: vm1 (определено автоматически)
    │
    ▼
⚙️ VM Manager выполняет:
    ssh ubuntu@92.5.72.169 "sudo systemctl restart grok-voice"
    │
    ▼
✅ Проверяет статус, отправляет результат
    │
    ▼
🔈 TTS озвучивает: "Сервис grok-voice перезапущен успешно"
    │
    ▼
📱 Пользователь слышит ответ
```

### Cross-Reboot схема

```
┌─────────────────────┐         ┌─────────────────────┐
│        VM1          │         │        VM2          │
│   92.5.72.169       │         │   158.180.56.74     │
├─────────────────────┤         ├─────────────────────┤
│                     │         │                     │
│  /home/ubuntu/      │         │  /home/ubuntu/      │
│  └─ .ssh/           │         │  └─ .ssh/           │
│     └─ vm2_key      │◄───────►│     └─ vm1_key      │
│                     │   SSH   │                     │
│  reboot_vm2.sh ─────┼────────►│  (перезагружается)  │
│                     │         │                     │
│  (перезагружается) ◄┼─────────┤─ reboot_vm1.sh      │
│                     │         │                     │
│  /agent/            │         │  /agent/            │
│  └─ health_check.py │◄──ping──┤  └─ health_check.py │
│                     │         │                     │
└─────────────────────┘         └─────────────────────┘

Каждые 60 сек VM1 пингует VM2 и наоборот.
Если 3 пинга подряд неудачны → оповещение + возможность reboot.
```
